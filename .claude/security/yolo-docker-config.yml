version: '3.8'

services:
  verone-yolo-dev:
    image: node:18-alpine
    container_name: verone-yolo-secure

    # ISOLATION MAXIMALE
    network_mode: 'bridge'
    security_opt:
      - no-new-privileges:true
      - apparmor:unconfined

    # FILESYSTEM PROTECTION
    read_only: false # Need write for development
    tmpfs:
      - /tmp:noexec,nosuid,size=2g
      - /var/tmp:noexec,nosuid,size=1g

    # RESOURCE LIMITS
    mem_limit: 4g
    cpus: 2.0

    # SAFE VOLUMES ONLY
    volumes:
      - ./src:/app/src:rw
      - ./public:/app/public:rw
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
      - ./next.config.js:/app/next.config.js:ro
      - ./tailwind.config.js:/app/tailwind.config.js:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./postcss.config.js:/app/postcss.config.js:ro
      - /app/node_modules # Anonymous volume
      - yolo-safe-cache:/app/.next

    # ENVIRONMENT PROTECTION
    environment:
      - NODE_ENV=development
      - DOCKER_MODE=isolation
      - NETWORK_ISOLATION=true
      - PROTECTION_LEVEL=yolo-safe
      - ALLOWED_PATHS=/app/src,/app/public
      - NEXT_TELEMETRY_DISABLED=1

    # SECURITY COMMAND
    working_dir: /app
    command: >
      sh -c "
        echo 'ğŸ”’ YOLO SECURE MODE STARTING...' &&
        echo 'ğŸ³ Container: verone-yolo-secure' &&
        echo 'ğŸ›¡ï¸ Protection Level: MAXIMUM' &&
        npm install --production=false &&
        echo 'âœ… Dependencies installed securely' &&
        echo 'ğŸš€ Starting development server...' &&
        npm run dev
      "

    ports:
      - '3000:3000'

    # HEALTH CHECK
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  yolo-safe-cache:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
