# Exemple de documentation KPI au format YAML
# Ce fichier sert de template pour documenter tous les KPI métier Vérone

name: Stock Turnover Rate
description: |
  Mesure la vitesse à laquelle le stock est renouvelé sur une période donnée.
  Un taux élevé indique une rotation rapide (bon), un taux faible indique un stock dormant (mauvais).
  Formule classique : Coût des marchandises vendues / Valeur moyenne du stock

category: Stock
subcategory: Rotation

# Formule mathématique (LaTeX ou texte)
formula: |
  turnover_rate = cost_of_goods_sold / average_inventory_value

  Où:
  - cost_of_goods_sold (COGS) = Somme(unit_cost × quantity) des ventes sur la période
  - average_inventory_value = Moyenne(stock_real × cost_price) sur la période

# Inputs nécessaires au calcul
inputs:
  - name: cost_of_goods_sold
    type: number
    unit: EUR
    description: Coût des marchandises vendues sur la période
    source: sales_order_items (unit_cost, quantity)
    query: |
      SELECT COALESCE(SUM(soi.unit_cost * soi.quantity), 0) as cogs
      FROM sales_order_items soi
      JOIN sales_orders so ON so.id = soi.sales_order_id
      WHERE so.status IN ('confirmed', 'shipped', 'delivered')
        AND so.created_at >= :start_date
        AND so.created_at <= :end_date
        AND so.organisation_id = :organisation_id

  - name: average_inventory_value
    type: number
    unit: EUR
    description: Valeur moyenne du stock sur la période
    source: products (stock_real) + price_list_items (cost_price)
    query: |
      SELECT COALESCE(AVG(p.stock_real * pli.cost_price), 0) as avg_inventory
      FROM products p
      LEFT JOIN price_list_items pli ON pli.product_id = p.id
      WHERE pli.price_list_id = (
        SELECT id FROM price_lists
        WHERE organisation_id = :organisation_id
        AND is_default = true
        LIMIT 1
      )
      AND p.archived_at IS NULL
      AND p.organisation_id = :organisation_id

# Output du calcul
output:
  type: number
  unit: ratio
  format: "0.00"
  description: Taux de rotation du stock (nombre de fois renouvelé)

# Seuils d'interprétation (adaptables par secteur)
thresholds:
  excellent: "> 8"
  good: "4-8"
  warning: "2-4"
  critical: "< 2"
  interpretation: |
    - Excellent (> 8) : Stock très dynamique, rotation rapide
    - Good (4-8) : Rotation saine, gestion efficace
    - Warning (2-4) : Stock potentiellement sur-stocké
    - Critical (< 2) : Stock dormant, risque obsolescence

# Scénarios de test (validation formule)
tests:
  - scenario: "Stock très rapide (rotation = 10)"
    description: "Cas d'un produit à forte demande"
    inputs:
      cost_of_goods_sold: 100000
      average_inventory_value: 10000
    expected_output: 10.0
    threshold_expected: "excellent"

  - scenario: "Stock normal (rotation = 6)"
    description: "Cas d'un produit standard"
    inputs:
      cost_of_goods_sold: 60000
      average_inventory_value: 10000
    expected_output: 6.0
    threshold_expected: "good"

  - scenario: "Stock lent (rotation = 1.5)"
    description: "Cas d'un produit à faible demande"
    inputs:
      cost_of_goods_sold: 15000
      average_inventory_value: 10000
    expected_output: 1.5
    threshold_expected: "critical"

  - scenario: "Pas de ventes (rotation = 0)"
    description: "Cas d'un produit jamais vendu"
    inputs:
      cost_of_goods_sold: 0
      average_inventory_value: 10000
    expected_output: 0.0
    threshold_expected: "critical"

  - scenario: "Stock vide (division par zéro)"
    description: "Cas d'un stock nul"
    inputs:
      cost_of_goods_sold: 10000
      average_inventory_value: 0
    expected_output: null # ou Infinity selon implémentation
    error_expected: true

# Références croisées
references:
  documentation:
    - docs/metrics/calculations.md
    - docs/metrics/dashboard-kpis.md
  code:
    - src/hooks/use-stock-metrics.ts
    - src/lib/kpi/stock-turnover.ts
  database:
    - docs/database/SCHEMA-REFERENCE.md (sales_order_items, products)

# Tests unitaires associés
unit_tests:
  file: packages/kpi/tests/stock-turnover.test.ts
  framework: Vitest
  coverage_target: 100%

# Hook React associé
react_hook:
  file: packages/kpi/hooks/use-stock-turnover.ts
  example: |
    import { useStockTurnover } from '@verone/kpi/hooks'

    export function StockMetrics() {
      const { turnoverRate, threshold, loading, error } = useStockTurnover({
        organisationId: 'uuid',
        startDate: '2025-01-01',
        endDate: '2025-12-31'
      })

      return (
        <KPICard
          title="Taux de rotation stock"
          value={turnoverRate}
          threshold={threshold}
          unit="× /an"
        />
      )
    }

# Métadonnées
metadata:
  created_at: 2025-10-21
  last_updated: 2025-10-21
  validated_by: Romeo Dos Santos
  version: 1.0.0
  status: active # active | deprecated | draft
  owner: stock_team

# Notes et contexte business
business_notes: |
  **Contexte Vérone** :
  - Mobilier haut de gamme = rotation plus lente qu'autres secteurs
  - Objectif : 4-6× /an (bon pour notre secteur)
  - Alertes automatiques si < 2× /an (stock dormant)

  **Actions correctives si mauvais** :
  - Promotions sur produits dormants
  - Révision quantités commandes fournisseurs
  - Analyse besoins clients (forecast)

# Alertes automatiques (future)
alerts:
  - condition: "turnover_rate < 2"
    severity: critical
    notification: email + dashboard
    message: "Stock dormant détecté : taux rotation < 2"
  - condition: "turnover_rate > 12"
    severity: warning
    notification: dashboard
    message: "Rotation très rapide : risque rupture stock"

# Benchmarks secteur (optionnel)
benchmarks:
  - sector: "Mobilier haut de gamme"
    source: "Étude IPEA 2024"
    average: 4.5
    excellent: "> 7"
  - sector: "E-commerce général"
    source: "Shopify Benchmark 2024"
    average: 8.2
    excellent: "> 12"
