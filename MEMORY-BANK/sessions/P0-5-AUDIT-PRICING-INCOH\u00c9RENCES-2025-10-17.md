# üö® P0-5: AUDIT PRICING - INCOH√âRENCES CRITIQUES

**Date**: 2025-10-17
**S√©v√©rit√©**: üî¥ CRITIQUE M√âTIER
**Impact**: Risque calculs prix faux, marges erron√©es, exports feeds incorrects

---

## üìä PROBL√àME IDENTIFI√â

### ‚úÖ SCH√âMA DB CORRECT (migrations SQL)

**Table `products`** (`20250916_010_fix_prices_to_euros.sql`):
```sql
price_ht NUMERIC(10,2) NOT NULL     -- Prix de VENTE HT
cost_price NUMERIC(10,2)            -- Prix d'ACHAT/Co√ªt fournisseur
```

**Table `product_drafts`** (`20250916_001_create_product_drafts.sql`):
```sql
supplier_price DECIMAL(10,2)   -- Prix achat fournisseur ‚Üí cost_price
selling_price DECIMAL(10,2)    -- Prix vente ‚Üí price_ht
```

### ‚ùå PROBL√àMES D√âTECT√âS

#### 1. Code TypeScript utilise colonne INEXISTANTE

**Fichier**: `src/hooks/use-products.ts:16`
```typescript
supplier_cost_price: number  // ‚ùå Cette colonne N'EXISTE PAS en DB!
```

**Impact**: Queries SQL √©chouent ou retournent `undefined`

#### 2. Commentaires INVERS√âS (CORRIG√âS)

**Avant** (‚ùå):
```sql
supplier_price -- mapp√© vers price_ht  ‚ùå FAUX
selling_price  -- mapp√© vers cost_price ‚ùå FAUX
```

**Apr√®s** (‚úÖ):
```sql
supplier_price -- mapp√© vers cost_price ‚úÖ CORRECT
selling_price  -- mapp√© vers price_ht   ‚úÖ CORRECT
```

#### 3. Champs marqu√©s @deprecated INCORRECTEMENT

**Fichier**: `src/hooks/use-products.ts:22-23`
```typescript
price_ht?: number      // @deprecated ‚ùå FAUX - C'est le champ PRINCIPAL!
cost_price?: number    // @deprecated ‚ùå FAUX - C'est le champ PRINCIPAL!
```

---

## üîç FICHIERS AFFECT√âS (Grep complet)

### Hooks avec incoh√©rences:
1. **use-products.ts** - Utilise `supplier_cost_price` (inexistant)
2. **use-sourcing-products.ts** - Mix de `cost_price` et `supplier_cost_price`
3. **use-product-variants.ts** - Utilise `price_ht: productData.cost_price` (confusion)
4. **use-variant-products.ts** - Calculs avec `cost_price` correct
5. **use-collections.ts** - Utilise `cost_price` correct

### Migrations corrig√©es:
- ‚úÖ `20250916_001_create_product_drafts.sql` - Commentaires fix√©s

---

## ‚ö†Ô∏è IMPACT M√âTIER

### Risques critiques:
1. **Calculs marges faux** - Si code utilise mauvaise colonne
2. **Prix exports Google/Meta erron√©s** - Feeds utilisent mauvais champ
3. **Devis clients incorrects** - Prix vente si confusion cost_price/price_ht
4. **Commandes fournisseurs montants faux** - Prix achat invers√©
5. **Rapports financiers incoh√©rents** - M√©triques CA, marges

### Sc√©narios bloquants:
- ‚ùå Cr√©ation produit √©choue (colonne `supplier_cost_price` introuvable)
- ‚ùå Affichage prix produit retourne `undefined`
- ‚ùå Calculs marge impossible (pas de prix achat)

---

## ‚úÖ S√âMANTIQUE CORRECTE √Ä APPLIQUER

```typescript
// Table products - COLONNES R√âELLES DB
interface Product {
  price_ht: number       // Prix de VENTE HT (ex: 1299.99‚Ç¨)
  cost_price: number     // Prix d'ACHAT fournisseur (ex: 899.50‚Ç¨)
  margin_percentage: number // Calcul√©: ((price_ht - cost_price) / cost_price) * 100
}

// Table product_drafts - WORKFLOW SOURCING
interface ProductDraft {
  supplier_price: number  // Prix achat ‚Üí cost_price (lors validation)
  selling_price: number   // Prix vente ‚Üí price_ht (lors validation)
}
```

---

## üîß PLAN DE CORRECTION

### Phase 1: Audit complet (2h)
1. ‚úÖ Grep toutes occurrences `cost_price|price_ht|supplier_cost_price`
2. ‚úÖ V√©rifier sch√©ma DB r√©el (migrations)
3. ‚úÖ Identifier fichiers affect√©s
4. ‚úÖ Cr√©er ce rapport

### Phase 2: Corrections migrations SQL (‚úÖ FAIT - 30min)
1. ‚úÖ Corriger commentaires `20250916_001_create_product_drafts.sql`
   - Ligne 31: `supplier_price` ‚Üí `cost_price` ‚úÖ
   - Ligne 32: `selling_price` ‚Üí `price_ht` ‚úÖ
   - Lignes 104-105: COMMENT ON COLUMN fix√©s ‚úÖ

### Phase 3: Corrections TypeScript (‚è≥ EN COURS)
1. ‚è≥ `use-products.ts`: Supprimer `supplier_cost_price`, utiliser `cost_price`
2. ‚è≥ `use-products.ts`: Retirer `@deprecated` de `price_ht` et `cost_price`
3. ‚è≥ `use-sourcing-products.ts`: Standardiser sur `cost_price` uniquement
4. ‚è≥ `use-product-variants.ts`: Corriger `price_ht: productData.cost_price`
5. ‚è≥ Autres hooks: V√©rifier coh√©rence

### Phase 4: Tests validation (2h)
1. ‚è≥ Console error check pages produits
2. ‚è≥ Test cr√©ation produit (sourcing ‚Üí catalogue)
3. ‚è≥ Test affichage prix (catalogue, devis)
4. ‚è≥ Test calculs marge
5. ‚è≥ Test exports feeds (Google/Meta)

---

## üìã NEXT ACTIONS IMM√âDIATES

### üî¥ CRITIQUE (Maintenant)
1. D√©cider: Corriger imm√©diatement ou reporter ?
2. Si corriger: Refactoriser 5 hooks (3-4h travail)
3. Si reporter: Documenter risques et workaround temporaire

### Recommandation:
**‚úÖ CORRIGER IMM√âDIATEMENT** car :
- Risque financier direct (prix faux)
- Bloque cr√©ation produits (colonne inexistante)
- Impact feeds Google/Meta (visibilit√© business)

---

## üìé FICHIERS MODIFI√âS

### Corrections appliqu√©es (‚úÖ):
- `supabase/migrations/20250916_001_create_product_drafts.sql` (lignes 31-32, 104-105)

### √Ä corriger (‚è≥):
- `src/hooks/use-products.ts`
- `src/hooks/use-sourcing-products.ts`
- `src/hooks/use-product-variants.ts`
- `src/components/business/product-card.tsx` (possiblement)

---

**Rapport g√©n√©r√©**: 2025-10-17 00:45
**Auteur**: Claude Code Audit P0-5
**Status**: ‚è≥ EN COURS - Corrections SQL ‚úÖ, Corrections TypeScript ‚è≥
