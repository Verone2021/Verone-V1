name: Quality Checks (ESLint + Type-Check + Build)

on:
  pull_request:
    branches:
      - main
      - staging
      - integration/*
  push:
    branches:
      - main
      - staging

# Annuler les workflows en cours si nouveau push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: ESLint + Type-Check + Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NÃ©cessaire pour comparer avec base branch

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ESLint Check
        id: eslint
        run: |
          echo "## ðŸ” ESLint Results" >> $GITHUB_STEP_SUMMARY

          # Lancer ESLint et capturer le rÃ©sultat
          if pnpm lint 2>&1 | tee eslint-output.txt; then
            echo "âœ… **ESLint**: No errors found" >> $GITHUB_STEP_SUMMARY
            echo "eslint_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ **ESLint**: Errors detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 eslint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "eslint_status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Type-Check
        id: typecheck
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“˜ Type-Check Results" >> $GITHUB_STEP_SUMMARY

          if pnpm type-check 2>&1 | tee typecheck-output.txt; then
            echo "âœ… **Type-Check**: No type errors" >> $GITHUB_STEP_SUMMARY
            echo "typecheck_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ **Type-Check**: Type errors detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 typecheck-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "typecheck_status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Build
        id: build
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ—ï¸ Build Results" >> $GITHUB_STEP_SUMMARY

          if pnpm build 2>&1 | tee build-output.txt; then
            echo "âœ… **Build**: Successful" >> $GITHUB_STEP_SUMMARY
            echo "build_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ **Build**: Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 build-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "build_status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Comment PR on Failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let comment = '## âŒ Quality Checks Failed\n\n';

            // Ajouter dÃ©tails ESLint si Ã©chec
            if (fs.existsSync('eslint-output.txt')) {
              const eslintOutput = fs.readFileSync('eslint-output.txt', 'utf8');
              const errorLines = eslintOutput.split('\n').filter(line =>
                line.includes('error') || line.includes('âœ–')
              ).slice(0, 20);

              if (errorLines.length > 0) {
                comment += '### ðŸ”´ ESLint Errors\n\n';
                comment += '```\n';
                comment += errorLines.join('\n');
                comment += '\n```\n\n';
              }
            }

            // Ajouter dÃ©tails Type-Check si Ã©chec
            if (fs.existsSync('typecheck-output.txt')) {
              const typecheckOutput = fs.readFileSync('typecheck-output.txt', 'utf8');
              const errorLines = typecheckOutput.split('\n').filter(line =>
                line.includes('error TS') || line.includes('Error:')
              ).slice(0, 20);

              if (errorLines.length > 0) {
                comment += '### ðŸ“˜ Type Errors\n\n';
                comment += '```\n';
                comment += errorLines.join('\n');
                comment += '\n```\n\n';
              }
            }

            // Ajouter dÃ©tails Build si Ã©chec
            if (fs.existsSync('build-output.txt')) {
              const buildOutput = fs.readFileSync('build-output.txt', 'utf8');
              const errorLines = buildOutput.split('\n').filter(line =>
                line.includes('Error:') || line.includes('Failed')
              ).slice(0, 20);

              if (errorLines.length > 0) {
                comment += '### ðŸ—ï¸ Build Errors\n\n';
                comment += '```\n';
                comment += errorLines.join('\n');
                comment += '\n```\n\n';
              }
            }

            comment += '---\n\n';
            comment += '**Action Required**: Please fix these errors before merging.\n\n';
            comment += '**How to fix**:\n';
            comment += '1. Run `pnpm lint` locally to see all errors\n';
            comment += '2. Run `pnpm type-check` to check types\n';
            comment += '3. Run `pnpm build` to verify build\n';
            comment += '4. Fix errors and push again\n\n';
            comment += '**Pre-commit hook**: Make sure Husky pre-commit hook is installed (`pnpm prepare`)\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Success Summary
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… All Quality Checks Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint: No errors" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Type-Check: No type errors" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build: Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ This PR is ready for review!" >> $GITHUB_STEP_SUMMARY
