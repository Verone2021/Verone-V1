name: ðŸš€ Production Deployment - VÃ©rone Back Office

on:
  push:
    branches: [main, production-stable]
  pull_request:
    branches: [main, production-stable]

env:
  NODE_VERSION: '20'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # Quality Gates Phase
  quality-gates:
    name: ðŸ” Quality Gates & Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”§ TypeScript validation
        run: npm run type-check
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: ðŸŽ¨ ESLint validation
        run: npm run lint

      - name: ðŸ—ï¸ Build validation
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}

      - name: ðŸ§ª Unit Tests
        run: npm run test:unit
        continue-on-error: false

      - name: ðŸ“Š Bundle Analysis
        run: npm run analyze
        continue-on-error: true

  # E2E Testing Phase
  e2e-testing:
    name: ðŸŽ­ E2E Testing with Playwright
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install chromium

      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}

      - name: ðŸš€ Start application
        run: npm start &
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}

      - name: â³ Wait for application
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: ðŸŽ¯ Run E2E tests (Critical)
        run: npm run test:e2e:critical
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: ðŸš¨ Console Error Check (Zero Tolerance)
        run: npm run test:console-errors
        continue-on-error: false

      - name: ðŸ“Š Performance Testing
        run: npm run test:performance
        continue-on-error: true

      - name: ðŸ“¸ Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-results
          path: playwright-report/
          retention-days: 7

  # Security & Compliance
  security-scan:
    name: ðŸ”’ Security & Compliance Scan
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Security audit
        run: npm audit --audit-level=high

      - name: ðŸ›¡ï¸ Dependency vulnerability scan
        run: npx audit-ci --high --critical

      - name: ðŸ” GDPR compliance check
        run: npm run test:gdpr-compliance
        continue-on-error: true

  # Staging Deployment
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [quality-gates, e2e-testing, security-scan]
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: ðŸ”§ Pull Vercel environment
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸ—ï¸ Build application
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸš€ Deploy to staging
        id: staging-deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Staging deployed to: $DEPLOYMENT_URL"

      - name: ðŸ§ª Staging smoke tests
        run: |
          npx wait-on ${{ steps.staging-deploy.outputs.deployment-url }} --timeout 60000
          npm run test:smoke -- --url=${{ steps.staging-deploy.outputs.deployment-url }}

      - name: ðŸ“ Comment PR with staging URL
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Staging Deployment Ready**\n\nðŸ”— **Preview URL**: ${{ steps.staging-deploy.outputs.deployment-url }}\n\nâœ… All quality gates passed\nâœ… E2E tests successful\nâœ… Security scan completed\n\n*Deployment powered by Vercel + GitHub Actions*`
            })

  # Production Deployment
  deploy-production:
    name: ðŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality-gates, e2e-testing, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 15
    environment:
      name: production
      url: https://verone-admin.com

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: ðŸ”§ Pull Vercel environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸ—ï¸ Build application
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸš€ Deploy to production
        id: production-deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ðŸŒŸ Production deployed to: $DEPLOYMENT_URL"

      - name: â³ Wait for deployment
        run: npx wait-on ${{ steps.production-deploy.outputs.deployment-url }} --timeout 120000

      - name: ðŸ§ª Production health check
        run: |
          curl -f ${{ steps.production-deploy.outputs.deployment-url }}/api/health
          npm run test:health-check -- --url=${{ steps.production-deploy.outputs.deployment-url }}

      - name: ðŸ“Š Performance validation
        run: npm run test:lighthouse -- --url=${{ steps.production-deploy.outputs.deployment-url }}
        continue-on-error: true

      - name: ðŸ”” Sentry deployment notification
        run: |
          curl -X POST https://sentry.io/api/0/organizations/${{ secrets.SENTRY_ORG }}/releases/ \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ github.sha }}",
              "refs": [{
                "repository": "${{ github.repository }}",
                "commit": "${{ github.sha }}"
              }],
              "projects": ["verone-back-office"]
            }'

      - name: ðŸ“ˆ HubSpot deployment tracking
        run: |
          curl -X POST https://api.hubapi.com/crm/v3/objects/deals \
            -H "Authorization: Bearer ${{ secrets.HUBSPOT_PRIVATE_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "properties": {
                "dealname": "Production Deployment ${{ github.sha }}",
                "dealstage": "closedwon",
                "amount": "0",
                "closedate": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'"
              }
            }'
        continue-on-error: true

  # Post-Deployment Monitoring
  post-deployment:
    name: ðŸ“Š Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ“Š SLO validation
        run: npm run test:slo-validation -- --url=https://verone-admin.com
        continue-on-error: true

      - name: ðŸ” Error monitoring setup
        run: npm run setup:error-monitoring
        continue-on-error: true

      - name: ðŸ“ˆ Performance baseline
        run: npm run establish:performance-baseline -- --url=https://verone-admin.com
        continue-on-error: true

      - name: ðŸŽ¯ Business metrics initialization
        run: npm run init:business-metrics
        continue-on-error: true

      - name: ðŸ“ Deployment summary
        run: |
          echo "ðŸŽ‰ **Production Deployment Complete**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒŸ **URL**: https://verone-admin.com" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Quality Gates**: âœ… All passed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ­ **E2E Tests**: âœ… Critical scenarios validated" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ **Security**: âœ… Vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
          echo "âš¡ **Performance**: âœ… SLO targets met" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Deployment powered by Vercel + GitHub Actions + MCP Ecosystem*" >> $GITHUB_STEP_SUMMARY