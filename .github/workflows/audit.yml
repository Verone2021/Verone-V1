name: Code Audit & Quality Checks (NON-BLOQUANT)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'docs/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch: # Permet ex√©cution manuelle

permissions:
  pull-requests: write
  contents: read

jobs:
  audit:
    name: Audit Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # N√©cessaire pour certains audits (git history)

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run ESLint
        id: lint
        run: npm run lint
        continue-on-error: false # Bloquer si lint √©choue

      - name: Run TypeScript Check
        id: type-check
        run: npm run type-check
        continue-on-error: false # Bloquer si types invalides

      - name: Audit - Code Duplication
        run: npm run audit:duplicates
        continue-on-error: true # Warning uniquement
        id: duplicates

      - name: Audit - Circular Dependencies
        id: cycles
        run: npm run audit:cycles
        continue-on-error: true # Turborepo: structure apps/ packages/ - check optionnel

      - name: Audit - Dead Code
        run: npm run audit:deadcode
        continue-on-error: true # Warning uniquement

      - name: Audit - Spelling
        run: npm run audit:spelling
        continue-on-error: true # Warning uniquement

      - name: Generate Audit Summary
        if: always()
        run: |
          echo "## üìä Code Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint: ${{ steps.lint.outcome == 'success' && '‚úÖ' || '‚ùå' }}" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript: ${{ steps.type-check.outcome == 'success' && '‚úÖ' || '‚ùå' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Circular Dependencies: ${{ steps.cycles.outcome == 'success' && '‚úÖ No cycles' || '‚ùå Cycles detected' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ö†Ô∏è Warnings (non-blocking)" >> $GITHUB_STEP_SUMMARY
          echo "- Code Duplication: See logs" >> $GITHUB_STEP_SUMMARY
          echo "- Dead Code: See logs" >> $GITHUB_STEP_SUMMARY
          echo "- Spelling: See logs" >> $GITHUB_STEP_SUMMARY

      - name: Comment PR (if failed)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Code Audit Failed

              Some quality checks failed. Please review the workflow logs and fix the issues.

              **Critical failures** (must be fixed):
              - ESLint errors
              - TypeScript compilation errors
              - Circular dependencies

              **Warnings** (should be addressed):
              - Code duplication
              - Dead code
              - Spelling errors

              See [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
              `
            })

# Note: Ce workflow peut √™tre √©tendu avec:
# - Tests unitaires (Vitest)
# - Tests E2E (Playwright) sur PR critiques
# - Security scan (npm audit, Snyk)
# - Performance benchmarks
# - Bundle size check
