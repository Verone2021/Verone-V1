name: ğŸ“š Docs Governance

# âŒ WORKFLOW DISABLED - Python scripts removed
# Scripts docs-audit-v4.sh and docs-audit-apply.py have been deleted (no Python in repo)
# This workflow is kept for reference but will not execute

on:
  workflow_dispatch:
    inputs:
      disabled:
        description: 'This workflow is disabled - Python scripts removed'
        required: false
        default: 'true'
        type: boolean
  # âŒ DISABLED: Python dependencies removed
  # pull_request:
  #   paths:
  #     - 'docs/**'

jobs:
  lint:
    name: Lint Markdown
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“ Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: 'docs/**/*.md'
          config: '.markdownlint.json'
        continue-on-error: true

  triage:
    name: Docs Triage Audit (DISABLED - Python removed)
    runs-on: ubuntu-latest
    if: false  # âŒ Permanently disabled - docs-audit-v4.sh removed
    timeout-minutes: 10
    outputs:
      has_candidates: ${{ steps.audit.outputs.has_candidates }}

    steps:
      - name: âŒ Script Removed
        run: |
          echo "âŒ docs-audit-v4.sh has been removed (Python dependency)"
          echo "This workflow is disabled"
          exit 1

          # Find the latest JSON report
          REPORT=$(ls -t reports/docs-audit-v4-*.json 2>/dev/null | head -1)

          if [ -z "$REPORT" ]; then
            echo "No report generated"
            echo "has_candidates=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "report_path=$REPORT" >> $GITHUB_OUTPUT

          # Check if there are candidates for action
          DELETE_COUNT=$(jq '.stats.by_action.DELETE_CANDIDATE // 0' "$REPORT")
          ARCHIVE_COUNT=$(jq '.stats.by_action.ARCHIVE // 0' "$REPORT")
          MERGE_COUNT=$(jq '.stats.by_action.MERGE // 0' "$REPORT")

          echo "DELETE_CANDIDATE: $DELETE_COUNT"
          echo "ARCHIVE: $ARCHIVE_COUNT"
          echo "MERGE: $MERGE_COUNT"

          if [ "$DELETE_COUNT" -gt 0 ] || [ "$ARCHIVE_COUNT" -gt 0 ]; then
            echo "has_candidates=true" >> $GITHUB_OUTPUT
          else
            echo "has_candidates=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Upload Audit Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-triage-report
          path: |
            reports/docs-audit-v4-*.md
            reports/docs-audit-v4-*.json
          retention-days: 30

      - name: ğŸ’¬ Comment PR with Audit Summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportsDir = 'reports';

            if (!fs.existsSync(reportsDir)) {
              console.log('Reports directory does not exist');
              return;
            }

            const files = fs.readdirSync(reportsDir).filter(f => f.startsWith('docs-audit-v4-') && f.endsWith('.json'));
            if (files.length === 0) {
              console.log('No audit report found');
              return;
            }

            const latestReport = files.sort().reverse()[0];
            const report = JSON.parse(fs.readFileSync(`${reportsDir}/${latestReport}`, 'utf-8'));

            const stats = report.stats;
            const byAction = stats.by_action || {};

            const keepCount = byAction.KEEP || 0;
            const mergeCount = byAction.MERGE || 0;
            const archiveCount = byAction.ARCHIVE || 0;
            const deleteCount = byAction.DELETE_CANDIDATE || 0;

            const hasIssues = mergeCount > 0 || archiveCount > 0 || deleteCount > 0;
            const status = hasIssues ? 'âš ï¸' : 'âœ…';

            const comment = `## ${status} Docs Governance Report

**Summary:**
- ğŸ“„ Total docs: **${stats.files}**
- âœ… KEEP: **${keepCount}**
- ğŸ”€ MERGE: **${mergeCount}**
- ğŸ“¦ ARCHIVE: **${archiveCount}**
- ğŸ—‘ï¸ DELETE_CANDIDATE: **${deleteCount}**

**Duplicates:**
- Exact duplicates: ${stats.exact_duplicate_groups} groups
- Near-duplicates: ${stats.near_duplicate_pairs} pairs

---

ğŸ“Š **Full Report:** Download artifact \`docs-triage-report\` from this workflow run.

${hasIssues ? 'âš ï¸ **Attention:** Some docs may need cleanup. Review the report for details.' : 'âœ… Documentation is in good shape!'}
`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  auto-archive:
    name: Auto-Archive Stale Docs (DISABLED - Python removed)
    runs-on: ubuntu-latest
    needs: triage
    if: false  # âŒ Permanently disabled - Python scripts removed
    timeout-minutes: 10

    steps:
      - name: âŒ Scripts Removed
        run: |
          echo "âŒ Both docs-audit-v4.sh and docs-audit-apply.py removed (Python dependencies)"
          echo "This workflow is disabled"
          exit 1

      - name: ğŸ“Š Report changes (MANUAL MODE - No auto-PR)
        if: steps.apply.outputs.changes_made == 'true'
        run: |
          echo "========================================"
          echo "ğŸ“š Docs Governance Report"
          echo "========================================"
          echo ""
          echo "âš ï¸  Documentation changes detected:"
          echo ""
          git status --short
          echo ""
          echo "========================================"
          echo "ğŸš¨ MANUAL MODE ENABLED"
          echo "========================================"
          echo ""
          echo "No PR created automatically."
          echo ""
          echo "To apply these changes:"
          echo "  1. Review the changes above"
          echo "  2. Create branch: git checkout -b chore/docs-archive-YYYY-MM-DD"
          echo "  3. Commit: git add . && git commit -m '[NO-TASK] chore(docs): archive stale documentation'"
          echo "  4. Push: git push origin chore/docs-archive-YYYY-MM-DD"
          echo "  5. Create PR manually: gh pr create"
          echo ""
          echo "See workflow artifacts for full triage report."
          echo ""
