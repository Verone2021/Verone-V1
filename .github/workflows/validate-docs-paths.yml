name: Validate Documentation Paths

on:
  pull_request:
    paths:
      - 'docs/**/*.md'
      - 'README.md'
      - 'packages/README.md'
      - 'CLAUDE.md'
      - 'apps/**/*.ts'
      - 'apps/**/*.tsx'
      - 'packages/**/*.ts'
      - 'packages/**/*.tsx'
  push:
    branches:
      - main
      - production-stable
    paths:
      - 'docs/**/*.md'
      - 'README.md'
      - 'packages/README.md'
      - 'CLAUDE.md'
      - 'apps/**/*.ts'
      - 'apps/**/*.tsx'
      - 'packages/**/*.ts'
      - 'packages/**/*.tsx'

jobs:
  validate-paths:
    runs-on: ubuntu-latest
    name: Validate Turborepo Phase 4 Paths

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for obsolete root src/ references
        run: |
          echo "üîç V√©rification r√©f√©rences obsol√®tes src/ (racine)..."

          # Check uniquement dans apps/ et packages/ (code actif source), ignorer docs/
          OBSOLETE_REFS=$(grep -r "src/app\|src/components\|src/hooks\|src/lib\|src/types\|src/styles" \
            --include="*.ts" \
            --include="*.tsx" \
            --exclude-dir="node_modules" \
            --exclude-dir=".next" \
            --exclude-dir="dist" \
            apps/ packages/ 2>/dev/null | grep -v "/src/" || true)

          if [ -n "$OBSOLETE_REFS" ]; then
            echo "‚ùå √âCHEC: R√©f√©rences obsol√®tes src/ d√©tect√©es (structure pr√©-Turborepo):"
            echo "$OBSOLETE_REFS"
            echo ""
            echo "‚úÖ Chemins corrects Phase 4 Turborepo:"
            echo "  - apps/back-office/src/"
            echo "  - apps/site-internet/src/"
            echo "  - apps/linkme/src/"
            echo "  - packages/@verone/*/src/"
            exit 1
          fi

          echo "‚úÖ Aucune r√©f√©rence obsol√®te src/ d√©tect√©e"

      - name: Check for obsolete @/shared/modules imports
        run: |
          echo "üîç V√©rification imports obsol√®tes @/shared/modules..."

          OBSOLETE_IMPORTS=$(grep -r "@/shared/modules" \
            --include="*.ts" \
            --include="*.tsx" \
            --exclude-dir="node_modules" \
            --exclude-dir=".next" \
            --exclude-dir="docs/archives" \
            . || true)

          if [ -n "$OBSOLETE_IMPORTS" ]; then
            echo "‚ùå √âCHEC: Imports obsol√®tes @/shared/modules d√©tect√©s (structure pr√©-Turborepo):"
            echo "$OBSOLETE_IMPORTS"
            echo ""
            echo "‚úÖ Imports corrects Phase 4 Turborepo:"
            echo "  - import { X } from '@verone/products'"
            echo "  - import { Y } from '@verone/ui'"
            echo "  - import { Z } from '@verone/orders'"
            exit 1
          fi

          echo "‚úÖ Aucun import obsol√®te @/shared/modules d√©tect√©"

      - name: Check for double-path errors
        run: |
          echo "üîç V√©rification erreurs double-path (apps/back-office/apps/back-office/)..."

          # Check uniquement dans apps/ et packages/ (code actif)
          DOUBLE_PATHS=$(grep -r "apps/back-office/apps/back-office\|apps/site-internet/apps/site-internet\|apps/linkme/apps/linkme" \
            --include="*.ts" \
            --include="*.tsx" \
            --exclude-dir="node_modules" \
            --exclude-dir=".next" \
            --exclude-dir="dist" \
            apps/ packages/ 2>/dev/null || true)

          if [ -n "$DOUBLE_PATHS" ]; then
            echo "‚ùå √âCHEC: Erreurs double-path d√©tect√©es (typo):"
            echo "$DOUBLE_PATHS"
            echo ""
            echo "‚úÖ Chemins corrects:"
            echo "  - apps/back-office/ (pas apps/back-office/apps/back-office/)"
            exit 1
          fi

          echo "‚úÖ Aucune erreur double-path d√©tect√©e"

      - name: Validate @verone/* imports exist
        run: |
          echo "üîç Validation imports @verone/* (25 packages attendus)..."

          VERONE_IMPORTS=$(grep -rh "from '@verone/" \
            --include="*.ts" \
            --include="*.tsx" \
            apps/ packages/ 2>/dev/null | wc -l || echo "0")

          echo "üìä Imports @verone/* trouv√©s: $VERONE_IMPORTS"

          if [ "$VERONE_IMPORTS" -lt 500 ]; then
            echo "‚ö†Ô∏è WARNING: Nombre d'imports @verone/* suspicieusement bas ($VERONE_IMPORTS < 500)"
            echo "Ceci peut indiquer une r√©gression vers imports obsol√®tes"
            echo ""
            echo "Liste packages @verone/* attendus (25):"
            echo "  ui, products, orders, stock, customers, suppliers, organisations,"
            echo "  categories, collections, channels, finance, consultations, logistics,"
            echo "  dashboard, notifications, admin, types, utils, common, kpi,"
            echo "  eslint-config, prettier-config, ui-business, testing, integrations"
            # Ne pas faire √©chouer le workflow, juste warning
          else
            echo "‚úÖ Nombre d'imports @verone/* valid√©: $VERONE_IMPORTS"
          fi

      - name: Check for obsolete package.json references
        run: |
          echo "üîç V√©rification package.json obsol√®tes..."

          # V√©rifier qu'aucun package.json ne r√©f√©rence l'ancienne structure
          OBSOLETE_PKG=$(find apps packages -name "package.json" -type f -exec grep -l "\"src/\"" {} \; || true)

          if [ -n "$OBSOLETE_PKG" ]; then
            echo "‚ùå √âCHEC: package.json avec r√©f√©rences obsol√®tes \"src/\" d√©tect√©s:"
            echo "$OBSOLETE_PKG"
            exit 1
          fi

          echo "‚úÖ Aucune r√©f√©rence obsol√®te dans package.json"

      - name: Validate Turborepo structure integrity
        run: |
          echo "üîç Validation int√©grit√© structure Turborepo..."

          # V√©rifier que les 3 apps existent
          for app in back-office site-internet linkme; do
            if [ ! -d "apps/$app/src" ]; then
              echo "‚ùå √âCHEC: apps/$app/src/ n'existe pas"
              exit 1
            fi
          done

          # V√©rifier que packages/@verone existe
          if [ ! -d "packages/@verone" ]; then
            echo "‚ùå √âCHEC: packages/@verone/ n'existe pas"
            exit 1
          fi

          # Compter packages @verone (devrait √™tre 25)
          PACKAGE_COUNT=$(find packages/@verone -mindepth 1 -maxdepth 1 -type d | wc -l)
          echo "üìä Packages @verone/* trouv√©s: $PACKAGE_COUNT"

          if [ "$PACKAGE_COUNT" -lt 20 ]; then
            echo "‚ö†Ô∏è WARNING: Nombre de packages suspicieusement bas ($PACKAGE_COUNT < 20)"
            echo "Phase 4 Turborepo devrait avoir 25 packages @verone/*"
          else
            echo "‚úÖ Structure Turborepo valid√©e: $PACKAGE_COUNT packages"
          fi

      - name: Summary validation report
        if: success()
        run: |
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚úÖ VALIDATION PATHS TURBOREPO PHASE 4 - SUCC√àS"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "Validations pass√©es:"
          echo "  ‚úÖ Aucune r√©f√©rence obsol√®te src/ (racine)"
          echo "  ‚úÖ Aucun import obsol√®te @/shared/modules"
          echo "  ‚úÖ Aucune erreur double-path"
          echo "  ‚úÖ Imports @verone/* valid√©s"
          echo "  ‚úÖ Structure Turborepo int√®gre"
          echo ""
          echo "Architecture Phase 4 Turborepo respect√©e ‚ú®"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
