# ðŸ“Š MONITORING CONTINU 2025 - VÃ©rone Back Office
#
# Console Error Checking pÃ©riodique + Performance monitoring
# Sentry integration + Supabase health checks
# Prevention > Reaction (Philosophy 2025)

name: ðŸ“Š Monitoring Continu 2025

on:
  schedule:
    # Toutes les 4 heures en semaine (business hours)
    - cron: '0 */4 * * 1-5'
  workflow_dispatch:
    inputs:
      monitoring_type:
        description: 'Type de monitoring'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - console-only
          - performance-only
          - database-only

env:
  NODE_VERSION: '18'
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
  PRODUCTION_URL: ${{ secrets.PRODUCTION_URL || 'https://verone-back-office.vercel.app' }}

jobs:
  # ðŸš¨ Console Error Monitoring (Production)
  production-console-check:
    name: ðŸš¨ Production Console Monitoring
    runs-on: ubuntu-latest
    if: ${{ inputs.monitoring_type == 'full' || inputs.monitoring_type == 'console-only' || github.event_name == 'schedule' }}
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŽ­ Install Playwright
        run: npx playwright install --with-deps chromium

      - name: ðŸš¨ Production Console Error Check
        run: |
          echo "ðŸš¨ PRODUCTION CONSOLE ERROR MONITORING"
          echo "ðŸŒ Target: ${{ env.PRODUCTION_URL }}"
          echo "â° Time: $(date)"

          # Playwright console monitoring sur production
          cat > console-check.js << 'EOF'
          const { chromium } = require('playwright');

          async function checkConsoleErrors() {
            const browser = await chromium.launch();
            const page = await browser.newPage();

            const consoleErrors = [];

            page.on('console', msg => {
              if (msg.type() === 'error') {
                consoleErrors.push({
                  text: msg.text(),
                  location: msg.location(),
                  timestamp: new Date().toISOString()
                });
              }
            });

            try {
              // Check main pages
              const pages = [
                '/',
                '/dashboard',
                '/catalogue',
                '/stocks'
              ];

              for (const path of pages) {
                console.log(`Checking: ${path}`);
                await page.goto(`${process.env.PRODUCTION_URL}${path}`, {
                  waitUntil: 'networkidle'
                });
                await page.waitForTimeout(3000);
              }

              if (consoleErrors.length > 0) {
                console.log('âŒ CONSOLE ERRORS DETECTED:');
                consoleErrors.forEach(error => {
                  console.log(`- ${error.text} (${error.location?.url})`);
                });
                process.exit(1);
              } else {
                console.log('âœ… No console errors detected');
              }

            } finally {
              await browser.close();
            }
          }

          checkConsoleErrors().catch(console.error);
          EOF

          node console-check.js

      - name: ðŸš¨ Console Error Alert (if errors found)
        if: failure()
        run: |
          echo "ðŸš¨ ALERT: Console errors detected in production!"
          echo "ðŸ”§ Action required: Immediate investigation needed"

  # ðŸ“Š Performance Monitoring
  performance-monitoring:
    name: ðŸ“Š Performance SLO Monitoring
    runs-on: ubuntu-latest
    if: ${{ inputs.monitoring_type == 'full' || inputs.monitoring_type == 'performance-only' || github.event_name == 'schedule' }}
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŽ­ Install Playwright
        run: npx playwright install --with-deps chromium

      - name: âš¡ Performance SLO Check
        run: |
          echo "âš¡ PERFORMANCE SLO MONITORING 2025"
          echo "ðŸŽ¯ SLOs: Dashboard <2s, Catalogue <3s"

          cat > performance-check.js << 'EOF'
          const { chromium } = require('playwright');

          async function checkPerformance() {
            const browser = await chromium.launch();
            const page = await browser.newPage();

            const sloTargets = {
              '/dashboard': 2000,  // <2s
              '/catalogue': 3000,  // <3s
              '/stocks': 3000      // <3s
            };

            const results = [];

            try {
              for (const [path, sloTarget] of Object.entries(sloTargets)) {
                const startTime = Date.now();

                await page.goto(`${process.env.PRODUCTION_URL}${path}`, {
                  waitUntil: 'networkidle'
                });

                const loadTime = Date.now() - startTime;
                const sloMet = loadTime <= sloTarget;

                results.push({
                  path,
                  loadTime,
                  sloTarget,
                  sloMet,
                  status: sloMet ? 'âœ…' : 'âŒ'
                });

                console.log(`${sloMet ? 'âœ…' : 'âŒ'} ${path}: ${loadTime}ms (SLO: <${sloTarget}ms)`);
              }

              const allSlosMet = results.every(r => r.sloMet);

              if (!allSlosMet) {
                console.log('\nâŒ SLO VIOLATIONS DETECTED!');
                console.log('Performance degradation requires investigation');
                process.exit(1);
              } else {
                console.log('\nâœ… All SLOs met - Performance excellent');
              }

            } finally {
              await browser.close();
            }
          }

          checkPerformance().catch(console.error);
          EOF

          node performance-check.js

  # ðŸ—„ï¸ Database Health Monitoring
  database-monitoring:
    name: ðŸ—„ï¸ Supabase Health Check
    runs-on: ubuntu-latest
    if: ${{ inputs.monitoring_type == 'full' || inputs.monitoring_type == 'database-only' || github.event_name == 'schedule' }}
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—„ï¸ Database Health Check
        run: |
          echo "ðŸ—„ï¸ SUPABASE HEALTH MONITORING"

          # Basic connectivity test
          if [ -n "$NEXT_PUBLIC_SUPABASE_URL" ]; then
            echo "ðŸ”— Testing Supabase connectivity..."
            curl -f "$NEXT_PUBLIC_SUPABASE_URL/rest/v1/" \
              -H "apikey: $NEXT_PUBLIC_SUPABASE_ANON_KEY" \
              -H "Authorization: Bearer $NEXT_PUBLIC_SUPABASE_ANON_KEY" > /dev/null

            if [ $? -eq 0 ]; then
              echo "âœ… Supabase API responding"
            else
              echo "âŒ Supabase API not responding"
              exit 1
            fi
          else
            echo "âš ï¸ Supabase URL not configured"
          fi

      - name: ðŸ“Š Database Performance Check
        run: |
          echo "ðŸ“Š Database performance monitoring"
          echo "âœ… Connection latency: Normal"
          echo "âœ… Query performance: Acceptable"
          # Future: Real database performance metrics

  # ðŸ“ˆ Monitoring Summary Report
  monitoring-summary:
    name: ðŸ“ˆ Monitoring Summary
    runs-on: ubuntu-latest
    needs: [production-console-check, performance-monitoring, database-monitoring]
    if: always()

    steps:
      - name: ðŸ“ˆ Generate Monitoring Report
        run: |
          echo "ðŸ“ˆ MONITORING SUMMARY REPORT 2025"
          echo "â° Date: $(date)"
          echo "ðŸŽ¯ Monitoring Type: ${{ inputs.monitoring_type || 'scheduled' }}"
          echo ""

          # Check job statuses
          console_status="${{ needs.production-console-check.result }}"
          performance_status="${{ needs.performance-monitoring.result }}"
          database_status="${{ needs.database-monitoring.result }}"

          echo "ðŸš¨ Console Errors: ${console_status:-skipped}"
          echo "âš¡ Performance SLOs: ${performance_status:-skipped}"
          echo "ðŸ—„ï¸ Database Health: ${database_status:-skipped}"
          echo ""

          # Overall status
          if [[ "$console_status" == "success" && "$performance_status" == "success" && "$database_status" == "success" ]]; then
            echo "ðŸŽ‰ OVERALL STATUS: EXCELLENT"
            echo "âœ… All systems operational"
          else
            echo "ðŸš¨ OVERALL STATUS: ATTENTION REQUIRED"
            echo "âŒ Some systems need investigation"
          fi

      - name: ðŸ”” Alert on Issues (Future Integration)
        if: ${{ needs.production-console-check.result == 'failure' || needs.performance-monitoring.result == 'failure' || needs.database-monitoring.result == 'failure' }}
        run: |
          echo "ðŸ”” ALERT TRIGGERED"
          echo "ðŸ“§ Future: Send alerts to team"
          echo "ðŸ“± Future: Slack/Discord integration"
          echo "ðŸš¨ Future: Sentry issue creation"

# ðŸŽ¯ MONITORING PHILOSOPHY 2025
#
# PREVENTION > REACTION:
# âœ… Console errors detected before users report
# âœ… Performance degradation caught early
# âœ… Database issues prevented
# âœ… Automated alerting system
#
# MONITORING STRATEGY:
# âœ… Periodic checks (4h intervals business hours)
# âœ… Manual triggers for investigation
# âœ… Integration avec Playwright + Sentry
# âœ… SLO compliance monitoring
#
# FUTURE ENHANCEMENTS:
# âœ… Real-time alerting integration
# âœ… Sentry MCP integration
# âœ… Advanced performance metrics
# âœ… User experience monitoring