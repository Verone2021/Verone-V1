#!/bin/sh

echo "üîç Type-check avant push..."

# Detect which apps have been modified
CHANGED_FILES=$(git diff --cached --name-only HEAD~1 2>/dev/null || git diff --name-only HEAD~1 2>/dev/null || echo "")

# Check each app for changes
CHECK_BO=false
CHECK_LM=false
CHECK_SI=false
CHECK_PACKAGES=false

if echo "$CHANGED_FILES" | grep -q "^apps/back-office/"; then
  CHECK_BO=true
fi

if echo "$CHANGED_FILES" | grep -q "^apps/linkme/"; then
  CHECK_LM=true
fi

if echo "$CHANGED_FILES" | grep -q "^apps/site-internet/"; then
  CHECK_SI=true
fi

if echo "$CHANGED_FILES" | grep -q "^packages/"; then
  CHECK_PACKAGES=true
fi

# If packages changed, check all apps that depend on them
if [ "$CHECK_PACKAGES" = true ]; then
  echo "üì¶ Packages modifi√©s - type-check complet requis"
  if ! pnpm type-check; then
    echo "‚ùå Type-check √©chou√©. Push annul√©."
    exit 1
  fi
else
  # Filtered type-check for modified apps only
  FAILED=false

  if [ "$CHECK_BO" = true ]; then
    echo "   ‚Üí Type-check back-office..."
    if ! pnpm --filter @verone/back-office type-check; then
      FAILED=true
    fi
  fi

  if [ "$CHECK_LM" = true ]; then
    echo "   ‚Üí Type-check linkme..."
    if ! pnpm --filter @verone/linkme type-check; then
      FAILED=true
    fi
  fi

  if [ "$CHECK_SI" = true ]; then
    echo "   ‚Üí Type-check site-internet..."
    if ! pnpm --filter @verone/site-internet type-check; then
      FAILED=true
    fi
  fi

  # If no specific app detected, run minimal check
  if [ "$CHECK_BO" = false ] && [ "$CHECK_LM" = false ] && [ "$CHECK_SI" = false ]; then
    echo "   ‚Üí Aucune app sp√©cifique modifi√©e, skip type-check"
  fi

  if [ "$FAILED" = true ]; then
    echo "‚ùå Type-check √©chou√©. Push annul√©."
    exit 1
  fi
fi

echo "‚úÖ Type-check r√©ussi, push autoris√©"
echo "‚ÑπÔ∏è  Le build complet sera valid√© par GitHub Actions"
