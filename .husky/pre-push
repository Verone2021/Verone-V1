#!/bin/sh

echo "üîç Validation avant push (ESLint + Type-check)..."

# Detect which apps have been modified
CHANGED_FILES=$(git diff --cached --name-only HEAD~1 2>/dev/null || git diff --name-only HEAD~1 2>/dev/null || echo "")

# Check each app for changes
CHECK_BO=false
CHECK_LM=false
CHECK_SI=false
CHECK_PACKAGES=false

if echo "$CHANGED_FILES" | grep -q "^apps/back-office/"; then
  CHECK_BO=true
fi

if echo "$CHANGED_FILES" | grep -q "^apps/linkme/"; then
  CHECK_LM=true
fi

if echo "$CHANGED_FILES" | grep -q "^apps/site-internet/"; then
  CHECK_SI=true
fi

if echo "$CHANGED_FILES" | grep -q "^packages/"; then
  CHECK_PACKAGES=true
fi

FAILED=false

# --- ESLint Check ---
echo ""
echo "üìù ESLint..."

if [ "$CHECK_PACKAGES" = true ]; then
  echo "   üì¶ Packages modifi√©s - lint complet requis"
  if ! pnpm lint; then
    FAILED=true
    echo "   ‚ùå ESLint √©chou√©"
  fi
else
  if [ "$CHECK_BO" = true ]; then
    echo "   ‚Üí Lint back-office..."
    if ! pnpm --filter @verone/back-office lint; then
      FAILED=true
    fi
  fi

  if [ "$CHECK_LM" = true ]; then
    echo "   ‚Üí Lint linkme..."
    if ! pnpm --filter @verone/linkme lint; then
      FAILED=true
    fi
  fi

  if [ "$CHECK_SI" = true ]; then
    echo "   ‚Üí Lint site-internet..."
    if ! pnpm --filter @verone/site-internet lint; then
      FAILED=true
    fi
  fi

  if [ "$CHECK_BO" = false ] && [ "$CHECK_LM" = false ] && [ "$CHECK_SI" = false ]; then
    echo "   ‚Üí Aucune app sp√©cifique modifi√©e, skip lint"
  fi
fi

# --- Type-check ---
echo ""
echo "üìò Type-check..."

if [ "$CHECK_PACKAGES" = true ]; then
  echo "   üì¶ Packages modifi√©s - type-check complet requis"
  if ! pnpm type-check; then
    FAILED=true
    echo "   ‚ùå Type-check √©chou√©"
  fi
else
  if [ "$CHECK_BO" = true ]; then
    echo "   ‚Üí Type-check back-office..."
    if ! pnpm --filter @verone/back-office type-check; then
      FAILED=true
    fi
  fi

  if [ "$CHECK_LM" = true ]; then
    echo "   ‚Üí Type-check linkme..."
    if ! pnpm --filter @verone/linkme type-check; then
      FAILED=true
    fi
  fi

  if [ "$CHECK_SI" = true ]; then
    echo "   ‚Üí Type-check site-internet..."
    if ! pnpm --filter @verone/site-internet type-check; then
      FAILED=true
    fi
  fi

  if [ "$CHECK_BO" = false ] && [ "$CHECK_LM" = false ] && [ "$CHECK_SI" = false ]; then
    echo "   ‚Üí Aucune app sp√©cifique modifi√©e, skip type-check"
  fi
fi

# --- Result ---
if [ "$FAILED" = true ]; then
  echo ""
  echo "‚ùå Validation √©chou√©e. Push annul√©."
  exit 1
fi

echo ""
echo "‚úÖ ESLint + Type-check r√©ussis, push autoris√©"
echo "‚ÑπÔ∏è  Le build complet sera valid√© par GitHub Actions"
