#!/bin/sh
# PRE-COMMIT SIMPLIFIÉ 2026
# Objectif : < 1 seconde (vs 30-60s actuellement)
# Philosophie : CI/CD valide, pre-commit facilite

echo "⚡ Pre-commit (simplifié 2026)..."

# 1. Validation format commit message (< 0.1s)
# Skip validation if no message yet (will be validated by commit-msg hook)
# Pre-commit runs before message is written

# 2. Protection branche main (< 0.1s)
BRANCH=$(git branch --show-current)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo "❌ Cannot commit on main. Create feature branch first."
  exit 1
fi

# 3. Validation RLS patterns (< 0.1s, critique pour sécurité DB)
if ls supabase/migrations/*.sql 1> /dev/null 2>&1; then
  OBSOLETE=$(grep -h "CREATE POLICY\|USING\|WITH CHECK" supabase/migrations/*.sql | \
    grep -v "^--" | \
    grep -E "user_profiles\.(app|role)|raw_user_meta_data.*role" || true)

  if [ -n "$OBSOLETE" ]; then
    echo "❌ Pattern RLS obsolète détecté. Voir .claude/rules/database/rls-patterns.md"
    exit 1
  fi
fi

# 4. Prettier auto-format (< 0.5s pour fichiers stagés uniquement)
STAGED_FILES=$(git diff --staged --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md)$' || true)
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | xargs npx prettier --write --log-level=error
  echo "$STAGED_FILES" | xargs git add
fi

echo "✅ Pre-commit OK (< 1s) - Validation complète dans CI/CD"
