#!/bin/sh

# 1. GÃ©nÃ©ration types dÃ©sactivÃ©e (manuel via MCP recommandÃ©)
# Raison : Types gÃ©nÃ©rÃ©s uniquement APRÃˆS apply_migration (MCP workflow)
# Pour rÃ©gÃ©nÃ©rer manuellement : pnpm generate:types
# Ou via MCP : mcp__supabase__generate_typescript_types

# 2. Validation RLS patterns (CRITIQUE - bloque patterns obsolÃ¨tes)
echo "ðŸ” Validation patterns RLS..."
if ls supabase/migrations/*.sql 1> /dev/null 2>&1; then
  # Chercher patterns obsolÃ¨tes (ignorer commentaires SQL)
  OBSOLETE=$(grep -h "CREATE POLICY\|USING\|WITH CHECK" supabase/migrations/*.sql | \
    grep -v "^--" | \
    grep -E "user_profiles\.(app|role)(?! IS)|raw_user_meta_data.*role" || true)

  if [ -n "$OBSOLETE" ]; then
    echo "âŒ ERREUR: Pattern RLS obsolÃ¨te dÃ©tectÃ© dans migrations SQL"
    echo ""
    echo "Patterns INTERDITS:"
    echo "  âŒ user_profiles.app        (colonne N'EXISTE PAS)"
    echo "  âŒ user_profiles.role       (obsolÃ¨te, sauf pour admin check)"
    echo "  âŒ raw_user_meta_data->>'role' (fragile)"
    echo ""
    echo "Patterns OBLIGATOIRES:"
    echo "  âœ… is_backoffice_user()     (staff back-office)"
    echo "  âœ… is_back_office_admin()   (admin uniquement)"
    echo ""
    echo "RÃ©fÃ©rence: .claude/rules/database/rls-patterns.md"
    echo ""
    echo "Extrait dÃ©tectÃ©:"
    echo "$OBSOLETE"
    exit 1
  fi
fi
echo "âœ… RLS patterns corrects"

# 3. Lint-staged (ESLint + Prettier)
npx lint-staged
