#!/bin/sh

# 1. G√©n√©ration types d√©sactiv√©e (manuel via MCP recommand√©)
# Raison : Types g√©n√©r√©s uniquement APR√àS apply_migration (MCP workflow)
# Pour r√©g√©n√©rer manuellement : pnpm generate:types
# Ou via MCP : mcp__supabase__generate_typescript_types

# 2. Validation RLS patterns (CRITIQUE - bloque patterns obsol√®tes)
echo "üîç Validation patterns RLS..."
if ls supabase/migrations/*.sql 1> /dev/null 2>&1; then
  # Chercher patterns obsol√®tes (ignorer commentaires SQL)
  OBSOLETE=$(grep -h "CREATE POLICY\|USING\|WITH CHECK" supabase/migrations/*.sql | \
    grep -v "^--" | \
    grep -E "user_profiles\.(app|role)(?! IS)|raw_user_meta_data.*role" || true)

  if [ -n "$OBSOLETE" ]; then
    echo "‚ùå ERREUR: Pattern RLS obsol√®te d√©tect√© dans migrations SQL"
    echo ""
    echo "Patterns INTERDITS:"
    echo "  ‚ùå user_profiles.app        (colonne N'EXISTE PAS)"
    echo "  ‚ùå user_profiles.role       (obsol√®te, sauf pour admin check)"
    echo "  ‚ùå raw_user_meta_data->>'role' (fragile)"
    echo ""
    echo "Patterns OBLIGATOIRES:"
    echo "  ‚úÖ is_backoffice_user()     (staff back-office)"
    echo "  ‚úÖ is_back_office_admin()   (admin uniquement)"
    echo ""
    echo "R√©f√©rence: .claude/rules/database/rls-patterns.md"
    echo ""
    echo "Extrait d√©tect√©:"
    echo "$OBSOLETE"
    exit 1
  fi
fi
echo "‚úÖ RLS patterns corrects"

# 3. Lint-staged (ESLint + Prettier)
npx lint-staged

# 4. Type-check filtr√© (d√©tecte apps modifi√©es dans staged files)
bash scripts/type-check-precommit.sh
