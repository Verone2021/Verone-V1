# Test Artifacts Policy

**Generated:** 2026-01-20
**Context:** Phase 4.3 - Prevent accumulation of test artifacts (Playwright, screenshots, MCP)
**Status:** âœ… Implemented - Script exists, gitignore verified

---

## What Are Test Artifacts?

**Test artifacts** are files/directories generated during test execution that should **NOT** be committed to Git.

### Playwright Artifacts

Generated by `@playwright/test`:
- `playwright-report/` - HTML test reports
- `test-results/` - Test execution results, traces, videos
- `apps/*/playwright-report/` - App-specific reports
- `apps/*/test-results/` - App-specific results
- `apps/*/screenshots/` - Failed test screenshots

### Other Test Artifacts

- `coverage/` - Code coverage reports (if enabled)
- `tests/reports/` - Custom test reports
- `.turbo/` - Turborepo cache (optional cleanup)

### MCP Browser Artifacts

Generated by Playwright MCP server:
- `page-*.png` - Screenshots from browser automation
- `page-*.jpeg` - Screenshots (JPEG format)
- `trace-*.zip` - Playwright traces
- `video-*.webm` - Recorded videos

**Location:** Usually in project root or `tools/` directory.

---

## Lifecycle

### Generation

**When:** During test runs
- `npm run test:e2e` - Generates Playwright reports
- `npm run e2e:smoke` - Generates smoke test reports
- MCP browser commands - Generate screenshots/traces

**Where:** Root, `apps/*/`, or specified output directory

### Gitignore (Verified âœ…)

**File:** `.gitignore`

**Patterns (already present):**
```gitignore
# Playwright
playwright-report/
test-results/

# MCP & Claude artifacts
.claude/reports/**

# Audit reports (generated, not source)
/reports/
/tools/reports/
/tests/reports/

# Coverage
coverage/
```

**Status:** âœ… All test artifacts are gitignored

### Cleanup

**Manual cleanup:**
```bash
# Recommended: Use npm script
npm run clean:test-artifacts

# Or direct script execution
bash scripts/maintenance/clean-test-artifacts.sh
```

**What it removes:**
- `playwright-report/` (root + apps)
- `test-results/` (root + apps)
- `screenshots/` (apps only)
- `coverage/` (if present)

**Source:** `scripts/maintenance/clean-test-artifacts.sh` (exists since Phase 3)

### CI Cleanup

**CI environment:** Auto-cleanup before artifact upload

**Example (GitHub Actions):**
```yaml
- name: Clean old artifacts
  run: npm run clean:test-artifacts

- name: Run tests
  run: npm run test:e2e

- name: Upload artifacts
  uses: actions/upload-artifact@v3
  with:
    name: playwright-report
    path: playwright-report/
```

---

## Best Practices

### 1. Never Commit Artifacts

**Rule:** Test artifacts are **NEVER** committed to Git.

**Why:**
- Large file sizes (screenshots, videos, traces)
- Binary files (poor Git performance)
- Generated output (not source code)
- CI can regenerate on-demand

**Enforcement:** `.gitignore` patterns prevent accidental commits.

### 2. Regular Local Cleanup

**Frequency:** Weekly (or after major test runs)

**Command:**
```bash
npm run clean:test-artifacts
```

**Benefits:**
- Frees disk space
- Prevents confusion with old reports
- Speeds up file searches

### 3. Check Before Commit

**Pre-commit checklist:**
```bash
# Check git status
git status

# Should NOT see:
# - playwright-report/
# - test-results/
# - screenshots/
# - coverage/
# - page-*.png
```

**If artifacts appear in `git status`:**
1. Verify `.gitignore` patterns
2. Run `npm run clean:test-artifacts`
3. Run `git status` again (should be clean)

### 4. CI Artifact Retention

**CI platforms:** Configure retention policy

**Example (GitHub Actions):**
```yaml
- name: Upload artifacts
  uses: actions/upload-artifact@v3
  with:
    name: playwright-report
    path: playwright-report/
    retention-days: 7  # Auto-delete after 7 days
```

**Recommendation:** 7 days for test reports, 30 days for critical artifacts.

---

## Cleanup Script Details

### Location

`scripts/maintenance/clean-test-artifacts.sh`

### Usage

```bash
# Standard cleanup
npm run clean:test-artifacts

# Direct execution (from repo root)
bash scripts/maintenance/clean-test-artifacts.sh

# Check what would be deleted (dry-run - future enhancement)
# bash scripts/maintenance/clean-test-artifacts.sh --dry-run
```

### What It Does

1. **Playwright root artifacts:**
   - Removes `playwright-report/`
   - Removes `test-results/`

2. **App-specific artifacts:**
   - Removes `apps/*/playwright-report/`
   - Removes `apps/*/test-results/`
   - Removes `apps/*/screenshots/`

3. **Coverage reports:**
   - Removes `coverage/` (if present)

4. **Turborepo cache (optional):**
   - Commented out by default
   - Uncomment if needed: `.turbo/`

### Output

```
ðŸ§¹ Cleaning test artifacts...
  - Removing playwright-report/
  - Removing test-results/
  - Removing apps/back-office/playwright-report/
  - Removing apps/back-office/test-results/
âœ… Test artifacts cleaned

Artifacts removed:
  - playwright-report/
  - test-results/
  - apps/*/playwright-report/
  - apps/*/test-results/
  - apps/*/screenshots/
  - coverage/
```

### Safety

- **No data loss:** Only removes generated artifacts
- **Idempotent:** Safe to run multiple times
- **Fast:** Completes in < 1 second

---

## MCP Browser Artifacts

### Generated Files

MCP Playwright server generates:
- `page-*.png` - Screenshots from browser automation
- `page-*.jpeg` - JPEG screenshots
- Saved in project root or specified directory

### Cleanup

**Not included in automated cleanup** (too generic pattern).

**Manual cleanup:**
```bash
# List MCP screenshots
ls -lh page-*.png page-*.jpeg 2>/dev/null

# Remove MCP screenshots (if desired)
rm -f page-*.png page-*.jpeg
```

**Recommendation:**
- Keep recent screenshots for debugging
- Delete after debugging complete
- Never commit to Git (add to `.gitignore` if needed)

---

## Troubleshooting

### Artifacts Still in Git Status

**Problem:** `git status` shows test artifacts

**Solution:**
1. Check `.gitignore` patterns:
   ```bash
   grep -E "playwright|test-results|screenshots|coverage" .gitignore
   ```

2. If patterns missing, add to `.gitignore`:
   ```gitignore
   playwright-report/
   test-results/
   screenshots/
   coverage/
   ```

3. Remove from Git cache (if already tracked):
   ```bash
   git rm -r --cached playwright-report test-results
   git commit -m "chore: remove test artifacts from git"
   ```

### Disk Space Issues

**Problem:** Test artifacts consuming too much disk space

**Solution:**
```bash
# Check artifact sizes
du -sh playwright-report test-results coverage apps/*/playwright-report apps/*/test-results

# Clean all artifacts
npm run clean:test-artifacts

# Verify cleanup
du -sh playwright-report test-results coverage apps/*/playwright-report apps/*/test-results
```

### CI Artifacts Too Large

**Problem:** CI artifact upload fails (size limit)

**Solution:**
1. Reduce Playwright trace/video settings:
   ```typescript
   // playwright.config.ts
   use: {
     trace: 'on-first-retry', // Not 'on' (reduces size)
     video: 'retain-on-failure', // Not 'on'
   }
   ```

2. Filter artifacts in CI:
   ```yaml
   - name: Upload only failures
     uses: actions/upload-artifact@v3
     with:
       name: failed-tests
       path: test-results/**/test-failed-*.png
   ```

---

## Summary

**Status:** âœ… Artifacts policy implemented

**Key points:**
- Test artifacts are **never** committed (gitignored)
- Cleanup script exists: `npm run clean:test-artifacts`
- Run cleanup weekly or after major test runs
- CI auto-cleans before artifact upload
- MCP screenshots require manual cleanup (generic pattern)

**Files:**
- `.gitignore` - Patterns verified âœ…
- `scripts/maintenance/clean-test-artifacts.sh` - Cleanup script âœ…
- `package.json` - npm script `clean:test-artifacts` âœ…

**Next steps:**
- Run cleanup weekly: `npm run clean:test-artifacts`
- Configure CI artifact retention (7-30 days)
- Monitor disk space in CI (if large artifacts)

---

**Policy Status:** âœ… COMPLETE - No action required, existing setup is correct
**Next:** Phase 4.4 (known issues + README root)
