'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { zodResolver } from '@hookform/resolvers/zod'
import { useForm } from 'react-hook-form'
import { z } from 'zod'
import { toast } from 'sonner'

import { ContratFormData, ContratAvecRelations, CONTRAT_DEFAULTS, CONTRAT_TYPES } from '@/types/contrats'
import { createContrat, updateContrat, getProprietesForSelection, getUnitesForProperty } from '@/actions/contrats'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Separator } from '@/components/ui/separator'
import { Switch } from '@/components/ui/switch'
import { Combobox } from '@/components/ui/combobox'
import { 
  Select, 
  SelectContent, 
  SelectItem, 
  SelectTrigger, 
  SelectValue 
} from '@/components/ui/select'
import { 
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form'
import { 
  Calendar,
  Home,
  Building2,
  Percent,
  Clock,
  Euro,
  FileText,
  AlertTriangle,
  Shield
} from 'lucide-react'

// Schema de validation pour le formulaire
const contratFormSchema = z.object({
  target_type: z.enum(['propriete', 'unite'], {
    required_error: 'Vous devez selectionner le type de bien'
  }),
  propriete_id: z.string().optional(),
  unite_id: z.string().optional(),
  type_contrat: z.enum(['fixe', 'variable'], {
    required_error: 'Vous devez selectionner le type de contrat'
  }),
  date_debut: z.string().min(1, 'La date de debut est requise'),
  date_fin: z.string().min(1, 'La date de fin est requise'),
  meuble: z.boolean().default(false),
  autorisation_sous_location: z.boolean().default(true),
  besoin_renovation: z.boolean().default(false),
  deduction_futurs_loyers: z.string().optional(),
  duree_imposee_mois: z.string().optional(),
  commission_pourcentage: z.string().default('10'),
  usage_proprietaire_jours_max: z.string().default('60')
}).superRefine((data, ctx) => {
  // Validation exclusive: propri√©t√© OU unit√©
  if (data.target_type === 'propriete' && !data.propriete_id) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      message: 'Vous devez selectionner une propriete',
      path: ['propriete_id']
    })
  }
  
  if (data.target_type === 'unite' && !data.unite_id) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      message: 'Vous devez selectionner une unite',
      path: ['unite_id']
    })
  }
  
  // Validation des dates
  if (data.date_debut && data.date_fin) {
    const dateDebut = new Date(data.date_debut)
    const dateFin = new Date(data.date_fin)
    
    if (dateFin <= dateDebut) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: 'La date de fin doit etre posterieure a la date de debut',
        path: ['date_fin']
      })
    }
  }
  
  // Validation des champs de renovation
  if (data.besoin_renovation) {
    if (data.deduction_futurs_loyers && isNaN(Number(data.deduction_futurs_loyers))) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: 'La deduction doit etre un nombre valide',
        path: ['deduction_futurs_loyers']
      })
    }
    
    if (data.duree_imposee_mois && isNaN(Number(data.duree_imposee_mois))) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: 'La duree doit etre un nombre valide',
        path: ['duree_imposee_mois']
      })
    }
  }
  
  // Validation des valeurs numeriques
  if (isNaN(Number(data.commission_pourcentage)) || Number(data.commission_pourcentage) < 0 || Number(data.commission_pourcentage) > 100) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      message: 'La commission doit etre entre 0 et 100%',
      path: ['commission_pourcentage']
    })
  }
  
  if (isNaN(Number(data.usage_proprietaire_jours_max)) || Number(data.usage_proprietaire_jours_max) < 0 || Number(data.usage_proprietaire_jours_max) > 365) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      message: "L'usage proprietaire doit etre entre 0 et 365 jours",
      path: ['usage_proprietaire_jours_max']
    })
  }
})

interface ContratFormProps {
  contrat?: ContratAvecRelations
  isEdit?: boolean
}

export function ContratForm({ contrat, isEdit = false }: ContratFormProps) {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [proprietes, setProprietes] = useState<Array<{id: string, nom: string}>>([])
  const [unites, setUnites] = useState<Array<{id: string, nom: string, numero: string}>>([])
  
  // Transform data for Combobox components
  const proprieteOptions = proprietes.map(p => ({ value: p.id, label: p.nom }))
  const uniteOptions = unites.map(u => ({ value: u.id, label: `Unite ${u.numero} - ${u.nom}` }))
  const contratTypeOptions = CONTRAT_TYPES.map(ct => ({ value: ct.value, label: ct.label }))
  const [loadingUnites, setLoadingUnites] = useState(false)

  // Configuration initiale du formulaire
  const form = useForm<ContratFormData>({
    resolver: zodResolver(contratFormSchema),
    defaultValues: {
      target_type: contrat?.propriete_id ? 'propriete' : contrat?.unite_id ? 'unite' : 'propriete',
      propriete_id: contrat?.propriete_id || '',
      unite_id: contrat?.unite_id || '',
      type_contrat: contrat?.type_contrat || 'fixe',
      date_debut: contrat?.date_debut ? contrat.date_debut.split('T')[0] : '',
      date_fin: contrat?.date_fin ? contrat.date_fin.split('T')[0] : '',
      meuble: contrat?.meuble ?? CONTRAT_DEFAULTS.meuble,
      autorisation_sous_location: contrat?.autorisation_sous_location ?? CONTRAT_DEFAULTS.autorisation_sous_location,
      besoin_renovation: contrat?.besoin_renovation ?? CONTRAT_DEFAULTS.besoin_renovation,
      deduction_futurs_loyers: contrat?.deduction_futurs_loyers?.toString() || '',
      duree_imposee_mois: contrat?.duree_imposee_mois?.toString() || '',
      commission_pourcentage: contrat?.commission_pourcentage?.toString() || CONTRAT_DEFAULTS.commission_pourcentage.toString(),
      usage_proprietaire_jours_max: contrat?.usage_proprietaire_jours_max?.toString() || CONTRAT_DEFAULTS.usage_proprietaire_jours_max.toString()
    }
  })

  const watchTargetType = form.watch('target_type')
  const watchProprieteid = form.watch('propriete_id')
  const watchBesoinRenovation = form.watch('besoin_renovation')
  const watchTypeContrat = form.watch('type_contrat')

  // Charger les proprietes au montage du composant
  useEffect(() => {
    const loadProprietes = async () => {
      try {
        const result = await getProprietesForSelection()
        if (result.success && result.data) {
          setProprietes(result.data)
        }
      } catch (error) {
        toast.error('Erreur lors du chargement des proprietes')
      }
    }
    
    loadProprietes()
  }, [])

  // Charger les unites quand une propriete est selectionnee
  useEffect(() => {
    if (watchTargetType === 'unite' && watchProprieteid) {
      const loadUnites = async () => {
        setLoadingUnites(true)
        try {
          const result = await getUnitesForProperty(watchProprieteid)
          if (result.success && result.data) {
            setUnites(result.data)
          } else {
            setUnites([])
          }
        } catch (error) {
          toast.error('Erreur lors du chargement des unites')
          setUnites([])
        } finally {
          setLoadingUnites(false)
        }
      }
      
      loadUnites()
    } else {
      setUnites([])
      form.setValue('unite_id', '')
    }
  }, [watchTargetType, watchProprieteid, form])

  // Reset des selections lors du changement de type
  useEffect(() => {
    if (watchTargetType === 'propriete') {
      form.setValue('unite_id', '')
    } else {
      form.setValue('propriete_id', '')
    }
  }, [watchTargetType, form])

  const onSubmit = async (data: ContratFormData) => {
    setLoading(true)
    
    try {
      // Transformation des donnees pour l'API
      const submitData = {
        organisation_id: '', // Sera gere cote serveur
        propriete_id: data.target_type === 'propriete' ? data.propriete_id : null,
        unite_id: data.target_type === 'unite' ? data.unite_id : null,
        type_contrat: data.type_contrat,
        date_debut: data.date_debut,
        date_fin: data.date_fin,
        meuble: data.meuble,
        autorisation_sous_location: data.autorisation_sous_location,
        besoin_renovation: data.besoin_renovation,
        deduction_futurs_loyers: data.deduction_futurs_loyers ? Number(data.deduction_futurs_loyers) : null,
        duree_imposee_mois: data.duree_imposee_mois ? Number(data.duree_imposee_mois) : null,
        commission_pourcentage: Number(data.commission_pourcentage),
        usage_proprietaire_jours_max: Number(data.usage_proprietaire_jours_max)
      }
      
      let result
      if (isEdit && contrat) {
        result = await updateContrat({ ...submitData, id: contrat.id })
      } else {
        result = await createContrat(submitData)
      }
      
      if (result.success) {
        toast.success(isEdit ? 'Contrat modifie avec succes' : 'Contrat cree avec succes')
        router.push(result.data ? `/contrats/${result.data.id}` : '/contrats')
      } else {
        toast.error(result.error || 'Une erreur est survenue')
      }
    } catch (error) {
      toast.error("Erreur inattendue lors de l'enregistrement")
    } finally {
      setLoading(false)
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
        {/* Selection du bien */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building2 className="h-5 w-5" />
              Bien concerne
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="target_type"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Type de bien</FormLabel>
                  <Select onValueChange={field.onChange} defaultValue={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selectionnez le type" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="propriete">üè† Propriete entiere</SelectItem>
                      <SelectItem value="unite">üè¢ Unite specifique</SelectItem>
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            {watchTargetType === 'propriete' && (
              <FormField
                control={form.control}
                name="propriete_id"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Propriete</FormLabel>
                    <FormControl>
                      <Combobox
                        options={proprieteOptions}
                        value={field.value}
                        onValueChange={field.onChange}
                        placeholder="Rechercher une propriete..."
                        searchPlaceholder="Tapez pour rechercher..."
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            )}

            {watchTargetType === 'unite' && (
              <>
                <FormField
                  control={form.control}
                  name="propriete_id"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Propriete parente</FormLabel>
                      <FormControl>
                        <Combobox
                          options={proprieteOptions}
                          value={field.value}
                          onValueChange={field.onChange}
                          placeholder="Rechercher une propriete..."
                          searchPlaceholder="Tapez pour rechercher..."
                        />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {watchProprieteid && (
                  <FormField
                    control={form.control}
                    name="unite_id"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Unite</FormLabel>
                        <FormControl>
                          <Combobox
                            options={uniteOptions}
                            value={field.value}
                            onValueChange={field.onChange}
                            placeholder={loadingUnites ? "Chargement..." : "Rechercher une unite..."}
                            searchPlaceholder="Tapez pour rechercher..."
                            disabled={loadingUnites}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                )}
              </>
            )}
          </CardContent>
        </Card>

        {/* Informations generales */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <FileText className="h-5 w-5" />
              Informations generales
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="type_contrat"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Type de contrat</FormLabel>
                  <FormControl>
                    <Combobox
                      options={contratTypeOptions}
                      value={field.value}
                      onValueChange={field.onChange}
                      placeholder="Selectionnez le type de contrat..."
                      searchPlaceholder="Rechercher..."
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="date_debut"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Date de debut</FormLabel>
                    <FormControl>
                      <Input type="date" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="date_fin"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Date de fin</FormLabel>
                    <FormControl>
                      <Input type="date" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Caracteristiques */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Home className="h-5 w-5" />
              Caracteristiques du bien
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            <FormField
              control={form.control}
              name="meuble"
              render={({ field }) => (
                <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                  <div className="space-y-0.5">
                    <FormLabel className="text-base">Bien meuble</FormLabel>
                    <FormDescription>
                      Le bien est-il loue meuble ?
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="autorisation_sous_location"
              render={({ field }) => (
                <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                  <div className="space-y-0.5">
                    <FormLabel className="text-base">Autorisation de sous-location</FormLabel>
                    <FormDescription>
                      Autoriser la sous-location sur plateformes (Airbnb, Booking, etc.)
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        {/* Renovations */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5" />
              Gestion des renovations
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="besoin_renovation"
              render={({ field }) => (
                <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                  <div className="space-y-0.5">
                    <FormLabel className="text-base">Besoin de r√©novation</FormLabel>
                    <FormDescription>
                      Le bien n√©cessite-t-il des r√©novations ?
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />

            {watchBesoinRenovation && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-orange-50 rounded-lg border border-orange-200">
                <FormField
                  control={form.control}
                  name="deduction_futurs_loyers"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>D√©duction futurs loyers (‚Ç¨)</FormLabel>
                      <FormControl>
                        <Input
                          type="number"
                          min="0"
                          step="0.01"
                          placeholder="0.00"
                          {...field}
                        />
                      </FormControl>
                      <FormDescription>
                        Montant √† d√©duire des loyers futurs
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="duree_imposee_mois"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Dur√©e impos√©e (mois)</FormLabel>
                      <FormControl>
                        <Input
                          type="number"
                          min="1"
                          max="120"
                          placeholder="6"
                          {...field}
                        />
                      </FormControl>
                      <FormDescription>
                        Dur√©e minimale impos√©e pour les r√©novations
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>
            )}
          </CardContent>
        </Card>

        {/* Conditions financi√®res - Conditionnelles selon le type */}
        {watchTypeContrat && (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Euro className="h-5 w-5" />
                {watchTypeContrat === 'fixe' ? 'Conditions financi√®res - Contrat Fixe' : 'Conditions financi√®res - Contrat Variable'}
              </CardTitle>
              <CardDescription>
                {watchTypeContrat === 'fixe' 
                  ? 'Montants fixes et conditions de location'
                  : 'Commission et revenus variables'
                }
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              
              {/* Champs pour contrat FIXE */}
              {watchTypeContrat === 'fixe' && (
                <div className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="montant_loyer_mensuel"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel className="flex items-center gap-2">
                            <Euro className="h-4 w-4" />
                            Loyer mensuel HT (‚Ç¨)
                          </FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min="0"
                              step="0.01"
                              placeholder="1500.00"
                              {...field}
                            />
                          </FormControl>
                          <FormDescription>
                            Montant du loyer mensuel hors taxes
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="depot_garantie"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel className="flex items-center gap-2">
                            <Shield className="h-4 w-4" />
                            D√©p√¥t de garantie (‚Ç¨)
                          </FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min="0"
                              step="0.01"
                              placeholder="3000.00"
                              {...field}
                            />
                          </FormControl>
                          <FormDescription>
                            Montant du d√©p√¥t de garantie
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="charges_mensuelles"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Charges mensuelles (‚Ç¨)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min="0"
                              step="0.01"
                              placeholder="200.00"
                              {...field}
                            />
                          </FormControl>
                          <FormDescription>
                            Montant des charges locatives mensuelles
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="plafond_depannage"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Plafond d√©pannages urgents (‚Ç¨)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min="0"
                              step="0.01"
                              placeholder="150.00"
                              {...field}
                            />
                          </FormControl>
                          <FormDescription>
                            Montant plafond pour les d√©pannages urgents
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </div>
              )}

              {/* Champs pour contrat VARIABLE */}
              {watchTypeContrat === 'variable' && (
                <div className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="commission_pourcentage"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel className="flex items-center gap-2">
                            <Percent className="h-4 w-4" />
                            Commission (%)
                          </FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min="0"
                              max="100"
                              step="0.01"
                              placeholder="10.00"
                              {...field}
                            />
                          </FormControl>
                          <FormDescription>
                            Pourcentage de commission sur les loyers
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="usage_proprietaire_jours_max"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel className="flex items-center gap-2">
                            <Clock className="h-4 w-4" />
                            Usage propri√©taire (jours/an)
                          </FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min="0"
                              max="365"
                              {...field}
                            />
                          </FormControl>
                          <FormDescription>
                            Nombre maximum de jours d'usage par le propri√©taire
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="estimation_revenus_mensuels"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel className="flex items-center gap-2">
                      <Euro className="h-4 w-4" />
                      Estimation revenus mensuels (‚Ç¨)
                    </FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min="0"
                        step="0.01"
                        placeholder="2500.00"
                        {...field}
                      />
                    </FormControl>
                    <FormDescription>
                      Estimation des revenus mensuels escompt√©s
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="frais_abonnement_internet"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel className="flex items-center gap-2">
                      <Building2 className="h-4 w-4" />
                      Abonnement internet (‚Ç¨/mois)
                    </FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min="0"
                        step="0.01"
                        placeholder="40.00"
                        {...field}
                      />
                    </FormControl>
                    <FormDescription>
                      Frais d'abonnement internet mensuel
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </div>
        )}

        <Separator />

        {/* Boutons d'action */}
        <div className="flex items-center justify-end gap-4">
          <Button
            type="button"
            variant="outline"
            onClick={() => router.back()}
            disabled={loading}
          >
            Annuler
          </Button>
          <Button
            type="submit"
            disabled={loading}
            className="bg-[#D4841A] hover:bg-[#B8731A] text-white min-w-[120px]"
          >
            {loading ? 'Enregistrement...' : isEdit ? 'Modifier' : 'Creer le contrat'}
          </Button>
        </div>
      </form>
    </Form>
  )
}